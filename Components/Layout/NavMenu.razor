@using BlazorWebApp.Services
@inject TabService TabService
@inject NavigationManager NavManager
@implements IDisposable

<div class="nav-scrollable @(IsExpanded ? "expanded" : "")">
    <nav class="flex-column">
        @foreach (var item in MenuItems)
        {
            <div class="nav-item">
                <div class="nav-link @(GetActiveClass(item.Url))" @onclick='() => OpenTab(item.Title, item.Url, item.Icon)'>
                    <div class="nav-icon"><span class="bi @item.Icon"></span></div>
                    <div class="nav-text">@item.Title</div>
                </div>
            </div>
        }
    </nav>
</div>

@code {
    [Parameter] public bool IsExpanded { get; set; }
    [Parameter] public EventCallback OnNavigate { get; set; }

    private List<MenuItem> MenuItems = new()
    {
        new MenuItem("Dashboard", "/", "bi-house-door"),
        new MenuItem("Veri Havuzu", "/data", "bi-table"),
        new MenuItem("Veri Havuzu - 2", "/data-pool-2", "bi-lightning-charge"),
        new MenuItem("Veri Havuzu - 3", "/data-pool-3", "bi-layers"),
        new MenuItem("Analiz Görünümü", "/analytics", "bi-grid-3x3-gap"),
        new MenuItem("Raporlar", "/reports", "bi-file-earmark-bar-graph"),
        new MenuItem("Ayarlar", "/settings", "bi-gear")
    };

    protected override void OnInitialized()
    {
        NavManager.LocationChanged += MapUrlToTab;
        // Don't auto-open tab on initial load for now to avoid clutter, or maybe we should?
        // User asked for "clicking there opens tab", which implies navigation action.
        // Let's ensure if we land on a specific page (deep link), the tab is there.
        MapUrlToTab(this, new LocationChangedEventArgs(NavManager.Uri, true));
    }

    private void MapUrlToTab(object? sender, LocationChangedEventArgs e)
    {
        var relativeUrl = NavManager.ToBaseRelativePath(e.Location);
        var url = relativeUrl == "" ? "/" : "/" + relativeUrl;

        // Strip query strings if any (basic implementation)
        if (url.Contains("?")) url = url.Split('?')[0];

        var item = MenuItems.FirstOrDefault(m => m.Url.Equals(url, StringComparison.OrdinalIgnoreCase));
        if (item != null)
        {
             // We use InvokeAsync to ensure thread safety with UI updates if needed, though TabService is simple C# class.
             // Calling AddTab will trigger state change in MainLayout
             TabService.AddTab(item.Title, item.Url, item.Icon, null);
             StateHasChanged();
        }
    }

    private async Task OpenTab(string title, string url, string icon)
    {
        await OnNavigate.InvokeAsync();
        // This is redundant now if MapUrlToTab works, but keeping it for direct feedback
        NavManager.NavigateTo(url);
    }

    private string GetActiveClass(string url)
    {
        var currentUrl = NavManager.ToBaseRelativePath(NavManager.Uri);
        if (string.IsNullOrEmpty(currentUrl) && url == "/") return "active";
        return ("/" + currentUrl).Equals(url, StringComparison.OrdinalIgnoreCase) ? "active" : "";
    }

    public void Dispose()
    {
        NavManager.LocationChanged -= MapUrlToTab;
    }

    private record MenuItem(string Title, string Url, string Icon);
}

