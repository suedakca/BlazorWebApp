@page "/data"
@using BlazorWebApp.Services
@using BlazorWebApp.Models
@inject PoolService PoolService
@inject IJSRuntime JSRuntime

<PageTitle>Veri Havuzu | Excel Görünümü</PageTitle>

<div class="h-100 w-100 d-flex flex-column bg-white">
    <FilterBar OnFilterChanged="HandleFilterChanged" />

    <div class="grid-controls p-2 d-flex justify-content-between align-items-center border-bottom bg-light">
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-success" @onclick="ExportExcel"><span class="bi bi-file-earmark-excel"></span><span class="d-none d-md-inline ms-1">Excel'e Aktar</span></button>
            <button class="btn btn-sm btn-outline-primary" @onclick='async () => await JSRuntime.InvokeVoidAsync("printPage")'><span class="bi bi-printer"></span><span class="d-none d-md-inline ms-1">Yazdır</span></button>
        </div>
        <div class="text-muted small">
             <span>Toplam <b>@totalCount</b> <span class="d-none d-sm-inline">kayıt listelendi.</span></span>
        </div>
    </div>

    <div class="table-wrapper flex-grow-1 overflow-auto">
        <table class="excel-table">
            <thead>
                <tr>
                    @foreach (var col in columns)
                    {
                        <th class="@col.HeaderCssClass" style="@(!string.IsNullOrEmpty(col.Width) ? $"width: {col.Width};" : "")">@col.HeaderText</th>
                    }
                </tr>
            </thead>
            <tbody>
                @if (isLoading)
                {
                    @for (int i = 0; i < 10; i++)
                    {
                        <tr class="skeleton-row">
                             @foreach (var col in columns)
                             {
                                 <td><div class="skeleton-box"></div></td>
                             }
                        </tr>
                    }
                }
                else
                {
                    <Virtualize ItemsProvider="LoadData" Context="item" @ref="virtualizeComponent">
                        <ItemContent>
                            <tr>
                                @foreach (var col in columns)
                                {
                                    <td class="@col.CssClass">
                                        @RenderCell(item, col)
                                    </td>
                                }
                            </tr>
                        </ItemContent>
                        <Placeholder>
                            <tr>
                                @foreach (var col in columns)
                                {
                                    <td><div class="skeleton-box"></div></td>
                                }
                            </tr>
                        </Placeholder>
                    </Virtualize>
                }
            </tbody>
        </table>
    </div>
</div>

<style>
    .excel-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.85rem;
    }

    .excel-table thead th {
        position: sticky;
        top: 0;
        background: #f8f9fa;
        color: var(--text-muted);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.58rem;
        letter-spacing: 0.5px;
        padding: 0.4rem 0.6rem;
        border-bottom: 2px solid var(--border-color);
        z-index: 10;
        border-right: 1px solid #f1f3f4;
    }

    .excel-table tbody td {
        padding: 0.35rem 0.6rem;
        border-bottom: 1px solid #f1f3f4;
        border-right: 1px solid #f1f3f4;
        transition: background 0.2s;
        vertical-align: middle;
        white-space: nowrap;
        color: var(--text-main);
        font-size: 0.8rem;
    }

    .excel-table tbody tr:hover td {
        background-color: #f8f9fa;
    }

    .col-index {
        width: 50px;
        color: #bdc1c6;
        text-align: center;
        background: #f8f9fa !important;
        border-right: 1px solid var(--border-color) !important;
    }

    .status-pill {
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.725rem;
        font-weight: 600;
        display: inline-block;
    }

    .status-pill.active {
        background: #e6f4ea;
        color: #137333;
    }

    .status-pill.inactive {
        background: #f1f3f4;
        color: #5f6368;
    }

    /* Priority Badges */
    .priority-badge {
        padding: 0.15rem 0.4rem;
        border-radius: 3px;
        font-size: 0.65rem;
        font-weight: 700;
        text-transform: uppercase;
    }
    .priority-badge.high { background: #feeef0; color: #d93025; }
    .priority-badge.medium { background: #feefc3; color: #f29900; }
    .priority-badge.low { background: #e8f0fe; color: #1a73e8; }

    /* Avatars */
    .avatar-sm {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: var(--primary-color);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
    }

    /* Payment Indicators */
    .payment-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 4px;
    }
    .payment-dot.paid { background: #34a853; }
    .payment-dot.pending { background: #fbbc04; }
    .payment-dot.overdue { background: #ea4335; }

    .skeleton-box {
        height: 12px;
        background: linear-gradient(90deg, #f0f0f0 25%, #e8eaed 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 4px;
        width: 100%;
    }

    @@keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }
</style>


@code {
    private List<PoolColumn> columns = new();
    private bool isLoading = true;
    private int totalCount = 0;
    private Virtualize<Dictionary<string, object>>? virtualizeComponent;
    private FilterBar.FilterCriteria currentCriteria = new();

    protected override async Task OnInitializedAsync()
    {
        // Use "UnifiedData" pool definition which maps to SampleDatas table
        columns = await PoolService.GetPoolColumnsAsync("UnifiedData");
        isLoading = false;
    }

    private async Task HandleFilterChanged(FilterBar.FilterCriteria criteria)
    {
        currentCriteria = criteria;
        if (virtualizeComponent != null)
        {
            await virtualizeComponent.RefreshDataAsync();
        }
    }
    
     private async ValueTask<ItemsProviderResult<Dictionary<string, object>>> LoadData(ItemsProviderRequest request)
    {
        var result = await PoolService.GetDynamicRecordsAsync("UnifiedData", request.StartIndex, request.Count, currentCriteria.Project, currentCriteria.Year);

        var items = result.Items;
        totalCount = result.TotalCount;
        
        return new ItemsProviderResult<Dictionary<string, object>>(items, totalCount);
    }
    
     private RenderFragment RenderCell(Dictionary<string, object> item, PoolColumn col) => builder =>
    {
        object? value = null;
        if (item.ContainsKey(col.PropertyName))
        {
            value = item[col.PropertyName];
        } else if (item.ContainsKey(col.PropertyName.Split('.')[0])) {
            value = item[col.PropertyName.Split('.')[0]];
        }

        if (col.DataType == "PriorityBadge")
        {
             var priority = value?.ToString() ?? "";
             builder.OpenElement(0, "span");
             builder.AddAttribute(1, "class", $"priority-badge {priority.ToLower()}");
             builder.AddContent(2, priority);
             builder.CloseElement();
        }
        else if (col.DataType == "StatusPill")
        {
             var status = value?.ToString() ?? "";
             var activeClass = status == "Active" ? "active" : "inactive";
             var text = status == "Active" ? "Aktif" : "Pasif";
             
             builder.OpenElement(0, "span");
             builder.AddAttribute(1, "class", $"status-pill {activeClass}");
             builder.AddContent(2, text);
             builder.CloseElement();
        }
        else if (col.DataType == "PaymentStatus")
        {
             var status = value?.ToString() ?? "";
             builder.OpenElement(0, "div");
             builder.AddAttribute(1, "class", "text-center");
             builder.OpenElement(2, "span");
             builder.AddAttribute(3, "class", $"payment-dot {status.ToLower()}");
             builder.CloseElement();
             builder.OpenElement(4, "span");
             builder.AddAttribute(5, "class", "x-small fw-bold");
             builder.AddContent(6, status);
             builder.CloseElement();
             builder.CloseElement();
        }
        else if (col.DataType == "UserAvatar")
        {
             var user = value?.ToString() ?? "?";
             var initial = user.Length > 0 ? user.Substring(0,1) : "?";
             
             builder.OpenElement(0, "div");
             builder.AddAttribute(1, "class", "d-flex align-items-center gap-2");
             builder.OpenElement(2, "div");
             builder.AddAttribute(3, "class", "avatar-sm");
             builder.AddContent(4, initial);
             builder.CloseElement();
             builder.AddContent(5, user);
             builder.CloseElement();
        }
         else if (col.DataType == "BadgeLight")
        {
            builder.OpenElement(0, "span");
            builder.AddAttribute(1, "class", "badge bg-light text-dark border");
            builder.AddContent(2, value?.ToString());
            builder.CloseElement();
        }
        else if (col.DataType == "Currency")
        {
             var amount = value is decimal d ? d : (value is double dbl ? (decimal)dbl : 0m);
            builder.AddContent(0, amount.ToString("N0"));
        }
        else
        {
            builder.AddContent(0, value?.ToString());
        }
    };

    private async Task ExportExcel()
    {
         if (totalCount == 0) return;
        var (items, count) = await PoolService.GetDynamicRecordsAsync("UnifiedData", 0, 1000); 
        
        var sb = new System.Text.StringBuilder();
        sb.AppendLine(string.Join(";", columns.Select(c => c.HeaderText)));
        
        foreach (var item in items)
        {
             var rowValues = new List<string>();
             foreach (var col in columns)
             {
                 var val = item.ContainsKey(col.PropertyName) ? item[col.PropertyName]?.ToString() : "";
                 val = val?.Replace(";", ",") ?? ""; 
                 rowValues.Add(val);
             }
             sb.AppendLine(string.Join(";", rowValues));
        }

        await JSRuntime.InvokeVoidAsync("downloadFile", "veri_havuzu.csv", "text/csv", sb.ToString());
    }
}
